<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共通テスト判定＆戦略アドバイザー v2.5</title>
    <meta name="description" content="全入試方式の一括判定に対応。傾斜配点・学習スケジュール・合否シミュレーター搭載。">
    
    <!-- OGP Tags -->
    <meta property="og:title" content="共テ判定＆戦略アドバイザー v2.5">
    <meta property="og:description" content="前期・後期・共テ利用など、全方式の判定を一覧表示。最適な出願戦略をサポートします。">
    <meta property="og:type" content="website">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        main {
            flex: 1;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .score-input {
            transition: all 0.2s;
        }
        .score-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .input-group {
            animation: fadeIn 0.3s ease-in-out;
        }
        .sub-input-group {
            background-color: #f8fafc;
            border-left: 3px solid #cbd5e1;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Simulator Slider */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
        /* Timeline Styles */
        .timeline {
            position: relative;
            padding-left: 1.5rem;
            border-left: 2px solid #e2e8f0;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
        }
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        .timeline-marker {
            position: absolute;
            left: -1.95rem;
            top: 0.25rem;
            width: 0.9rem;
            height: 0.9rem;
            border-radius: 50%;
            background: white;
            border: 3px solid #6366f1;
        }
        /* Exam List Table */
        .exam-row {
            transition: background-color 0.1s;
        }
        .exam-row:hover {
            background-color: #f8fafc;
        }
        @media print {
            header button, footer, .no-print { display: none; }
            body { background: white; }
            .card { box-shadow: none; border: 1px solid #eee; break-inside: avoid; }
            .exam-row { break-inside: avoid; }
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <i class="fa-solid fa-graduation-cap text-indigo-600 text-2xl"></i>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">共テ判定・戦略アドバイザー <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full ml-1 align-middle">v2.5 (Multi-View)</span></h1>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="resetData()" class="text-xs text-slate-400 hover:text-red-500 transition no-print mr-2" title="保存データを削除">
                    <i class="fa-solid fa-trash-can mr-1"></i>Reset
                </button>
                <button onclick="window.print()" class="text-slate-400 hover:text-indigo-600 transition text-xl" title="結果を印刷">
                    <i class="fa-solid fa-print"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Column: Settings & Input -->
            <div class="lg:col-span-4 space-y-6 no-print">
                <!-- User Profile -->
                <div class="card p-6 border-t-4 border-indigo-500">
                    <h2 class="text-lg font-bold mb-4 flex items-center text-slate-700">
                        <i class="fa-solid fa-sliders mr-2 text-indigo-500"></i>志望設定
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">志望分野（文理選択）</label>
                            <select id="fieldSelect" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-indigo-500 transition" onchange="updateFormUI(); saveData();">
                                <optgroup label="理系">
                                    <option value="science" selected>理系（工・理・農）</option>
                                    <option value="medical">理系（医・歯・薬）</option>
                                    <option value="info_sci">情報系（理系）</option>
                                </optgroup>
                                <optgroup label="文系">
                                    <option value="humanities">文系（文・教育・外国語）</option>
                                    <option value="social">文系（法・経済・経営）</option>
                                    <option value="info_arts">情報系（文系）</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">第一志望大学（任意）</label>
                            <input type="text" id="targetUni" placeholder="例: 北海道大学" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm" onchange="saveData()">
                        </div>
                    </div>
                </div>

                <!-- Score Input -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold flex items-center text-slate-700">
                            <i class="fa-solid fa-pencil mr-2 text-indigo-500"></i>素点入力
                        </h2>
                        <span id="subjectCountBadge" class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">--</span>
                    </div>
                    
                    <div class="space-y-1" id="scoreInputs">
                        <!-- Javascriptで動的に生成されます -->
                    </div>

                    <div class="mt-4 p-3 bg-blue-50 text-blue-800 text-xs rounded border border-blue-100">
                        <i class="fa-solid fa-floppy-disk mr-1"></i>
                        入力内容は自動保存されます。
                    </div>

                    <button onclick="runAnalysis()" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-200 transition active:scale-95 flex items-center justify-center group">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2 group-hover:rotate-12 transition"></i> 判定・分析開始
                    </button>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Summary Card -->
                <div class="card p-6 bg-slate-800 text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i class="fa-solid fa-chart-pie text-9xl"></i>
                    </div>
                    <div class="relative z-10 flex flex-col md:flex-row md:items-end justify-between gap-4">
                        <div>
                            <h3 class="text-slate-400 text-sm font-medium mb-1">総合偏差値（換算推計）</h3>
                            <div class="flex items-baseline space-x-3">
                                <span class="text-5xl font-bold tracking-tight" id="totalDev">--.-</span>
                                <span class="text-sm text-slate-400 bg-slate-700 px-2 py-1 rounded" id="totalScore">素点: ---</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <div class="text-right">
                                <div class="text-xs text-slate-400 mb-1">得意科目</div>
                                <span class="px-3 py-1 rounded bg-indigo-500 text-white text-sm font-bold" id="dominantSubject">---</span>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-slate-400 mb-1">対策優先</div>
                                <span class="px-3 py-1 rounded bg-rose-500 text-white text-sm font-bold" id="weakSubject">---</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Simulator Control (Hidden by default) -->
                <div id="simulatorPanel" class="card p-6 border-t-4 border-purple-500 hidden transition-all duration-300 no-print">
                    <h3 class="font-bold text-lg mb-2 flex items-center text-slate-800">
                        <i class="fa-solid fa-sliders mr-2 text-purple-500"></i>合否シミュレーター
                    </h3>
                    <p class="text-xs text-slate-500 mb-4">スライダーを動かして「あと◯点取れたら判定がどう変わるか」をシミュレーションできます（素点に加算）。</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-bold text-slate-700">英語ブースト</span>
                                <span class="text-purple-600 font-bold" id="simVal_eng">+0点</span>
                            </div>
                            <input type="range" id="simRange_eng" min="0" max="30" value="0" step="1" 
                                oninput="updateSimVal('eng', this.value); runAnalysis(true);">
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-bold text-slate-700">数学ブースト</span>
                                <span class="text-purple-600 font-bold" id="simVal_math">+0点</span>
                            </div>
                            <input type="range" id="simRange_math" min="0" max="30" value="0" step="1" 
                                oninput="updateSimVal('math', this.value); runAnalysis(true);">
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-bold text-slate-700">国語ブースト</span>
                                <span class="text-purple-600 font-bold" id="simVal_jp">+0点</span>
                            </div>
                            <input type="range" id="simRange_jp" min="0" max="30" value="0" step="1" 
                                oninput="updateSimVal('jp', this.value); runAnalysis(true);">
                        </div>
                    </div>
                </div>

                <!-- Analysis Results -->
                <div id="resultSection" class="space-y-6 opacity-50 pointer-events-none transition-opacity duration-500">
                    
                    <!-- University Recommendations -->
                    <div class="card p-6 border-t-4 border-indigo-500">
                        <h3 class="font-bold text-lg mb-1 flex items-center text-slate-800">
                            <i class="fa-solid fa-bullseye mr-2 text-indigo-500"></i>大学別・全入試方式判定
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">各大学のすべての入試方式について、傾斜配点を考慮した得点率と判定を表示します。</p>
                        <div class="space-y-4" id="uniRecommendations">
                            <div class="text-center text-slate-400 py-12 bg-slate-50 rounded-lg border border-dashed border-slate-200">
                                左側のフォームに点数を入力して判定を開始してください
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Hagan Port -->
                        <div class="card p-6 border-t-4 border-emerald-500 h-full">
                            <h3 class="font-bold text-lg mb-4 flex items-center text-slate-800">
                                <i class="fa-solid fa-anchor mr-2 text-emerald-500"></i>ヘイガン港（推奨併願校）
                            </h3>
                            <div class="space-y-3" id="haganPort">
                                <div class="text-center text-slate-400 py-8">---</div>
                            </div>
                        </div>

                        <!-- Chart -->
                        <div class="card p-6 border-t-4 border-amber-500 h-full flex flex-col">
                            <h3 class="font-bold text-lg mb-2 flex items-center text-slate-800">
                                <i class="fa-solid fa-chart-radar mr-2 text-amber-500"></i>科目バランス詳細
                            </h3>
                            <div class="flex-1 flex items-center justify-center min-h-[250px]">
                                <canvas id="radarChart"></canvas>
                            </div>
                            <p class="text-xs text-center text-slate-400 mt-2">国語は現・古・漢を個別に表示しています</p>
                        </div>
                    </div>

                    <!-- Strategy Text & Schedule -->
                    <div class="card p-6 bg-gradient-to-r from-indigo-50 to-white border border-indigo-100">
                        <h3 class="font-bold text-lg mb-1 flex items-center text-indigo-800">
                            <i class="fa-solid fa-clipboard-check mr-2"></i>合格への戦略ロードマップ
                        </h3>
                        <div id="strategyContent" class="text-sm leading-relaxed text-slate-700">
                            ---
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <footer class="bg-slate-50 border-t border-slate-200 mt-12 py-8 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-xs text-slate-500">
            <p class="mb-2">本ツールの判定は傾斜配点を考慮した独自のシミュレーション値です。実際の合否を保証するものではありません。</p>
            <p>&copy; 2025 Common Test Strategy Advisor v2.5 (Multi-View)</p>
        </div>
    </footer>

    <script>
        // --- 1. Data Definitions ---
        
        const conversionTables = {
            englishR:  { max: 100, points: [[100, 68.0], [80, 58.7], [60, 49.4], [40, 40.1], [20, 30.8], [0, 20.0]] },
            englishL:  { max: 100, points: [[100, 77.5], [80, 65.0], [60, 52.4], [40, 39.8], [20, 27.2], [0, 20.0]] },
            math1A:    { max: 100, points: [[100, 78.6], [80, 68.7], [60, 58.7], [40, 48.0], [20, 38.0], [0, 28.0]] },
            math2BC:   { max: 100, points: [[100, 68.5], [80, 59.4], [60, 50.3], [40, 41.1], [20, 32.0], [0, 22.0]] },
            japanese:  { max: 200, points: [[200, 79.9], [150, 63.2], [100, 46.6], [80, 39.9], [50, 29.9], [0, 20.0]] },
            jp_modern: { max: 110, points: [[110, 74.6], [90, 62.7], [70, 50.8], [50, 38.9], [30, 27.0], [10, 15.1]] },
            jp_ancient:{ max: 45, points: [[45, 72.0], [35, 62.3], [25, 52.6], [15, 42.9], [5, 30.0]] },
            jp_kanbun: { max: 45, points: [[45, 71.0], [35, 62.8], [25, 54.7], [15, 46.6], [5, 38.0]] },
            science:   { max: 100, points: [[100, 72.0], [80, 64.0], [60, 56.0], [40, 48.0], [20, 40.0], [0, 30.0]] },
            social:    { max: 100, points: [[100, 73.8], [80, 62.9], [60, 52.1], [40, 41.2], [20, 30.0], [0, 20.0]] },
            info:      { max: 100, points: [[100, 81.2], [80, 67.2], [60, 53.2], [40, 39.2], [20, 25.2], [0, 15.0]] }
        };

        const subjectMaster = {
            englishR: { name: '英語(R)', max: 100, table: 'englishR' },
            englishL: { name: '英語(L)', max: 100, table: 'englishL' },
            math1A:   { name: '数学I・A', max: 100, table: 'math1A' },
            math2BC:  { name: '数学II・B・C', max: 100, table: 'math2BC' },
            jp_modern: { name: '現代文', max: 110, table: 'jp_modern', isSub: true },
            jp_ancient:{ name: '古文', max: 45, table: 'jp_ancient', isSub: true },
            jp_kanbun: { name: '漢文', max: 45, table: 'jp_kanbun', isSub: true },
            info:     { name: '情報', max: 100, table: 'info' },
            science1: { name: '理科①', max: 100, table: 'science' },
            science2: { name: '理科②', max: 100, table: 'science' },
            social:   { name: '地歴公民', max: 100, table: 'social' },
            social1:  { name: '地歴公民①', max: 100, table: 'social' },
            social2:  { name: '地歴公民②', max: 100, table: 'social' },
            scienceBasic: { name: '理科基礎', max: 100, table: 'science' }
        };

        const universities = [
            { 
                name: "北海道大学", faculty: "総合理系", field: ["science", "medical", "info_sci"], 
                exams: [
                    { 
                        type: "前期", 
                        borderScoreRate: 0.76, 
                        desc: "標準的だが理系科目の配点がやや重い傾斜あり。",
                        weights: { englishR:1, englishL:1, math1A:1.2, math2BC:1.2, science1:1.2, science2:1.2, social:1, info:1, jp_modern:1, jp_ancient:1, jp_kanbun:1 }
                    },
                    { 
                        type: "後期", 
                        borderScoreRate: 0.82, 
                        desc: "理科重視。理科強者に圧倒的有利な配点。",
                        weights: { englishR:1, englishL:1, math1A:1, math2BC:1, science1:2.0, science2:2.0, social:1, info:0, jp_modern:0.5, jp_ancient:0.5, jp_kanbun:0.5 }
                    }
                ]
            },
            { 
                name: "小樽商科大学", faculty: "商学部", field: ["social", "info_arts"], 
                exams: [
                    { 
                        type: "前期", 
                        borderScoreRate: 0.65, 
                        desc: "<span class='font-bold text-indigo-600'>英語重視</span>。英語が2倍計算されるため逆転が起きやすい。",
                        weights: { englishR:2.0, englishL:2.0, math1A:1, math2BC:1, social1:1, social2:1, scienceBasic:1, info:1, jp_modern:1, jp_ancient:1, jp_kanbun:1 }
                    },
                    { 
                        type: "後期", 
                        borderScoreRate: 0.70, 
                        desc: "激戦区。全科目の高得点が求められる。",
                        weights: { englishR:1.5, englishL:1.5, math1A:1, math2BC:1, social1:1, social2:1, scienceBasic:1, info:1, jp_modern:1, jp_ancient:1, jp_kanbun:1 }
                    }
                ]
            },
            { 
                name: "室蘭工業大学", faculty: "理工学部", field: ["science", "info_sci"], 
                exams: [
                    { 
                        type: "前期", 
                        borderScoreRate: 0.58, 
                        desc: "数学・理科重視。英語が苦手でも理数でカバー可能。",
                        weights: { englishR:0.8, englishL:0.8, math1A:1.5, math2BC:1.5, science1:1.5, science2:1.5, social:0.5, info:1, jp_modern:0.5, jp_ancient:0.5, jp_kanbun:0.5 }
                    },
                     { 
                        type: "後期", 
                        borderScoreRate: 0.62, 
                        desc: "前期不合格組が流れてくるためボーダーは高め。",
                        weights: { englishR:1, englishL:1, math1A:1.5, math2BC:1.5, science1:1.5, science2:1.5, social:0.5, info:1, jp_modern:0.5, jp_ancient:0.5, jp_kanbun:0.5 }
                    }
                ]
            },
            { 
                name: "北海学園大学", faculty: "工学部", field: ["science", "info_sci"], 
                exams: [
                    { 
                        type: "共テ利用I期", 
                        borderScoreRate: 0.60, 
                        desc: "3教科3科目（英・数・理）。<span class='font-bold text-emerald-600'>ここを「港」として確保</span>推奨。",
                        weights: { englishR:1, englishL:1, math1A:1, math2BC:1, science1:1, science2:1 } 
                    },
                    { 
                        type: "一般入試", 
                        borderScoreRate: 0.55, 
                        desc: "2月入試。共テが悪くてもここでリベンジ可能。",
                        weights: { englishR:1, englishL:1, math1A:1, math2BC:1, science1:1, science2:1 } // Dummy weights for sim
                    }
                ]
            },
            { 
                name: "明治大学", faculty: "理工学部", field: ["science", "info_sci"], 
                exams: [
                    { 
                        type: "共テ利用(4教科)", 
                        borderScoreRate: 0.78, 
                        desc: "理科1科目でOK。高得点勝負。",
                        weights: { englishR:1, englishL:1, math1A:1, math2BC:1, science1:1 } 
                    },
                    { 
                        type: "共テ利用(3教科)", 
                        borderScoreRate: 0.82, 
                        desc: "科目負担が軽いがボーダーは跳ね上がる。",
                        weights: { englishR:1, englishL:1, math1A:1, math2BC:1, science1:1 } 
                    }
                ]
            },
             { 
                name: "北海学園大学", faculty: "経済学部", field: ["social", "info_arts"], 
                exams: [
                    { type: "共テ利用I期", borderScoreRate: 0.62, desc: "3科目型（英・国・地歴公民）。", weights: {englishR:1, englishL:1, jp_modern:1, jp_ancient:1, jp_kanbun:1, social1:1} },
                    { type: "共テ利用II期", borderScoreRate: 0.65, desc: "募集人数が少ないため難化する。", weights: {englishR:1, englishL:1, jp_modern:1, jp_ancient:1, jp_kanbun:1, social1:1} }
                ]
            },
            { 
                name: "東北大学", faculty: "工学部", field: ["science", "info_sci"], 
                exams: [
                    { type: "前期", borderScoreRate: 0.79, desc: "数学・理科の比重が大きい。", weights: {englishR:1, englishL:1, math1A:1.5, math2BC:1.5, science1:1.5, science2:1.5, social:1, info:1, jp_modern:1, jp_ancient:1, jp_kanbun:1} }
                ]
            },
            { 
                name: "東京理科大学", faculty: "工学部", field: ["science", "info_sci"], 
                exams: [
                    { type: "A方式", borderScoreRate: 0.75, desc: "科目選択の自由度が高い。", weights: {englishR:1, englishL:1, math1A:1, math2BC:1, science1:1} },
                    { type: "C方式", borderScoreRate: 0.72, desc: "共テ＋独自試験。独自の配点比率が高い。", weights: {englishR:1, englishL:1, math1A:1, math2BC:1, science1:1} }
                ]
            }
        ];

        // --- 2. Logic Functions ---

        let currentSubjectKeys = [];
        let simulationOffsets = { eng: 0, math: 0, jp: 0 };

        function init() {
            loadData();
            updateFormUI(false); 
        }

        function updateFormUI(clearValues = true) {
            const field = document.getElementById('fieldSelect').value;
            const container = document.getElementById('scoreInputs');
            const badge = document.getElementById('subjectCountBadge');
            
            let tempValues = {};
            if (!clearValues) {
                const inputs = container.querySelectorAll('input');
                inputs.forEach(input => {
                    tempValues[input.id] = input.value;
                });
            }

            container.innerHTML = '';
            
            const japaneseSet = ['jp_modern', 'jp_ancient', 'jp_kanbun'];
            
            if (['humanities', 'social', 'info_arts'].includes(field)) {
                subjects = ['englishR', 'englishL', 'math1A', 'math2BC', ...japaneseSet, 'social1', 'social2', 'scienceBasic', 'info'];
                badge.innerText = "文系型: 入力項目多数";
                badge.className = "text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded";
            } else {
                subjects = ['englishR', 'englishL', 'math1A', 'math2BC', ...japaneseSet, 'science1', 'science2', 'social', 'info'];
                badge.innerText = "理系型: 標準";
                badge.className = "text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded";
            }

            currentSubjectKeys = subjects;

            subjects.forEach((key, index) => {
                const sub = subjectMaster[key];
                const div = document.createElement('div');
                const isSub = sub.isSub ? "sub-input-group" : "";
                const indent = sub.isSub ? "pl-4" : "";
                const labelStyle = sub.isSub ? "text-xs text-slate-600" : "text-sm font-medium text-slate-700";

                div.className = `input-group flex items-center justify-between p-2 rounded-lg border-b border-transparent hover:border-slate-100 ${isSub}`;
                div.style.animationDelay = `${index * 0.02}s`;
                div.innerHTML = `
                    <label class="${labelStyle} w-1/2 ${indent}">${sub.name}</label>
                    <div class="flex items-center w-1/2 space-x-2">
                        <input type="number" id="score_${key}" max="${sub.max}" min="0" placeholder="-" 
                            class="score-input w-full bg-white border border-slate-300 rounded px-3 py-2 text-right font-mono text-slate-700"
                            onchange="validateScore(this, ${sub.max}); saveData();">
                        <span class="text-xs text-slate-400 w-8">/${sub.max}</span>
                    </div>
                `;
                container.appendChild(div);

                if (tempValues[`score_${key}`]) {
                    document.getElementById(`score_${key}`).value = tempValues[`score_${key}`];
                } else if (!clearValues) {
                    const saved = localStorage.getItem(`score_${key}`);
                    if (saved) document.getElementById(`score_${key}`).value = saved;
                }
            });
        }

        function validateScore(input, max) {
            let val = parseInt(input.value);
            if (val < 0) input.value = 0;
            if (val > max) input.value = max;
        }

        function calculateWeightedScore(userScores, examWeights) {
            let totalWeightedScore = 0;
            let maxWeightedScore = 0;

            Object.keys(examWeights).forEach(subject => {
                const weight = examWeights[subject];
                const userScore = userScores[subject] || 0;
                const maxScore = subjectMaster[subject].max;

                totalWeightedScore += userScore * weight;
                maxWeightedScore += maxScore * weight;
            });

            return {
                score: totalWeightedScore,
                max: maxWeightedScore,
                rate: maxWeightedScore > 0 ? totalWeightedScore / maxWeightedScore : 0
            };
        }

        function getScoresFromUI(applySim = false) {
            let scores = {};
            currentSubjectKeys.forEach(key => {
                const el = document.getElementById(`score_${key}`);
                let val = el.value === "" ? 0 : parseInt(el.value);
                
                if (applySim) {
                    if ((key === 'englishR' || key === 'englishL') && simulationOffsets.eng > 0) val += simulationOffsets.eng;
                    if ((key === 'math1A' || key === 'math2BC') && simulationOffsets.math > 0) val += simulationOffsets.math;
                    if (['jp_modern','jp_ancient','jp_kanbun'].includes(key) && simulationOffsets.jp > 0) {
                         if (key === 'jp_modern') val = Math.min(110, val + simulationOffsets.jp);
                    }
                }
                
                val = Math.min(val, subjectMaster[key].max);
                scores[key] = val;
            });
            return scores;
        }

        function runAnalysis(isSim = false) {
            const resultSection = document.getElementById('resultSection');
            resultSection.style.opacity = "1";
            resultSection.style.pointerEvents = "auto";
            if(!isSim) document.getElementById('simulatorPanel').classList.remove('hidden');

            const scores = getScoresFromUI(isSim);

            let totalDevSum = 0;
            let count = 0;
            let subjectDevs = {};
            let jpScoreSum = 0;
            let totalRawScore = 0;

            Object.keys(scores).forEach(key => {
                totalRawScore += scores[key];
                if (['jp_modern', 'jp_ancient', 'jp_kanbun'].includes(key)) {
                    jpScoreSum += scores[key];
                    subjectDevs[subjectMaster[key].name] = calculateDeviation(subjectMaster[key].table, scores[key]);
                } else {
                    const dev = calculateDeviation(subjectMaster[key].table, scores[key]);
                    subjectDevs[subjectMaster[key].name] = dev;
                    totalDevSum += dev;
                    count++;
                }
            });
            
            if (scores['jp_modern'] !== undefined) {
                totalDevSum += calculateDeviation('japanese', jpScoreSum);
                count++;
            }

            const avgDev = count > 0 ? totalDevSum / count : 0;

            document.getElementById('totalScore').innerText = `素点: ${totalRawScore}`;
            document.getElementById('totalDev').innerText = avgDev.toFixed(1);

            const sortedDevs = Object.entries(subjectDevs).sort((a,b) => b[1] - a[1]);
            document.getElementById('dominantSubject').innerText = sortedDevs[0][0];
            document.getElementById('weakSubject').innerText = sortedDevs[sortedDevs.length-1][0];

            renderRecommendations(scores, avgDev);
            renderRadarChart(subjectDevs);
            if (!isSim) renderStrategy(avgDev, sortedDevs);
        }

        function calculateDeviation(tableKey, score) {
            const table = conversionTables[tableKey];
            if (!table) return 50.0;
            if (score >= table.points[0][0]) return table.points[0][1];
            if (score <= table.points[table.points.length-1][0]) return table.points[table.points.length-1][1];
            for (let i = 0; i < table.points.length - 1; i++) {
                const high = table.points[i];
                const low = table.points[i+1];
                if (score <= high[0] && score >= low[0]) {
                    const ratio = (score - low[0]) / (high[0] - low[0]);
                    return low[1] + ratio * (high[1] - low[1]);
                }
            }
            return 50.0;
        }

        function renderRecommendations(userScores, userAvgDev) {
            const field = document.getElementById('fieldSelect').value;
            const targetName = document.getElementById('targetUni').value;
            const recContainer = document.getElementById('uniRecommendations');
            const haganContainer = document.getElementById('haganPort');
            
            recContainer.innerHTML = "";
            haganContainer.innerHTML = "";

            let relevantUnis = universities.filter(u => u.field.includes(field));
            if(targetName) {
                const customMatches = universities.filter(u => u.name.includes(targetName));
                customMatches.forEach(cm => {
                    if (!relevantUnis.includes(cm)) relevantUnis.unshift(cm);
                });
            }

            let hasSafety = false;

            relevantUnis.forEach(uni => {
                // v2.5 Update: Process ALL exams for the university
                const examResults = uni.exams.map(exam => {
                    const result = calculateWeightedScore(userScores, exam.weights);
                    const diffRate = result.rate - exam.borderScoreRate;
                    
                    let judgment, colorClass, sortOrder;
                    if (diffRate >= 0.05) { judgment = "A"; colorClass = "text-emerald-600 bg-emerald-50"; sortOrder = 5; }
                    else if (diffRate >= 0.02) { judgment = "B"; colorClass = "text-indigo-600 bg-indigo-50"; sortOrder = 4; }
                    else if (diffRate >= -0.02) { judgment = "C"; colorClass = "text-amber-600 bg-amber-50"; sortOrder = 3; }
                    else if (diffRate >= -0.08) { judgment = "D"; colorClass = "text-orange-600 bg-orange-50"; sortOrder = 2; }
                    else { judgment = "E"; colorClass = "text-rose-600 bg-rose-50"; sortOrder = 1; }
                    
                    return { exam, result, judgment, colorClass, sortOrder };
                });

                // Find best for Hagan logic
                examResults.sort((a,b) => b.sortOrder - a.sortOrder);
                const bestResult = examResults[0];

                // Create Card with List
                recContainer.innerHTML += createUniCardWithList(uni, examResults);

                // Add to Hagan Port if Safe
                if (bestResult.sortOrder >= 5) { // A判定
                    haganContainer.innerHTML += createHaganCard(uni, bestResult);
                    hasSafety = true;
                }
            });

             if (!hasSafety) {
                haganContainer.innerHTML = `<div class="text-sm text-rose-500 bg-rose-50 p-3 rounded border border-rose-100">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                    安全圏の大学が見つかりません。独自日程の私大併願を検討してください。
                </div>`;
            }
        }

        // v2.5 New Card Generator (List View)
        function createUniCardWithList(uni, results) {
            let listRows = results.map(r => {
                const rate = (r.result.rate * 100).toFixed(1);
                const border = (r.exam.borderScoreRate * 100).toFixed(1);
                // Highlight best option
                const isBest = r === results[0]; 
                const rowStyle = isBest ? "bg-slate-50 font-medium" : "";
                const checkMark = isBest ? `<i class="fa-solid fa-check text-indigo-500 ml-1"></i>` : "";

                return `
                <div class="exam-row grid grid-cols-12 gap-2 py-2 border-b border-slate-100 text-sm items-center ${rowStyle}">
                    <div class="col-span-4 flex items-center">
                        <span class="text-slate-700">${r.exam.type}</span>
                        ${checkMark}
                    </div>
                    <div class="col-span-2 text-center">
                        <span class="font-bold px-2 py-0.5 rounded ${r.colorClass}">${r.judgment}判定</span>
                    </div>
                    <div class="col-span-3 text-right font-mono text-xs">
                        ${rate}% <span class="text-slate-400">/ ${border}%</span>
                    </div>
                    <div class="col-span-3 text-xs text-slate-500 pl-2 truncate" title="${r.exam.desc}">
                        ${r.exam.desc}
                    </div>
                </div>`;
            }).join('');

            return `
                <div class="flex flex-col p-4 bg-white border border-slate-100 shadow-sm rounded-lg mb-4 hover:shadow-md transition">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h4 class="font-bold text-slate-800 text-md">${uni.name}</h4>
                            <div class="text-xs text-slate-500">${uni.faculty}</div>
                        </div>
                    </div>
                    <div class="w-full">
                        ${listRows}
                    </div>
                </div>
            `;
        }

        function createHaganCard(uni, r) {
            return `
                <div class="p-3 bg-emerald-50 border border-emerald-100 rounded-lg mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-emerald-800 text-sm">${uni.name}</span>
                        <span class="bg-white text-emerald-600 px-2 py-0.5 rounded text-xs font-bold border border-emerald-200">A判定</span>
                    </div>
                    <div class="text-xs text-emerald-700">
                        <i class="fa-solid fa-check-circle mr-1"></i>${r.exam.type}方式で安全圏
                    </div>
                </div>
            `;
        }

        function renderStrategy(userDev, sortedDevs) {
            let html = "";
            const weak = sortedDevs[sortedDevs.length-1];
            const strong = sortedDevs[0];
            const weakName = weak[0];
            
            html += `<div class="mb-4">あなたの武器は<strong class="text-indigo-600">${strong[0]} (偏差値${strong[1].toFixed(1)})</strong>です。これを維持しつつ、<strong class="text-rose-600">${weakName}</strong>の底上げを図ることで総合偏差値を大きく伸ばせます。</div>`;

            let phase1Title = "直近2週間：基礎徹底";
            let phase1Content = "";
            let phase2Title = "来月：実戦演習";
            let phase2Content = "";
            let phase3Title = "直前期：時間配分";
            let phase3Content = "";

            if (userDev < 45) {
                phase1Content = `${weakName}の教科書・基本例題に戻りましょう。応用問題には手を付けず、公式や用語の定義を完璧に言えるようにしてください。`;
                phase2Content = `「大問1・2」など、基礎点の配点が高い分野だけをマーク模試の過去問で繰り返し解きます。難問は捨ててOK。`;
                phase3Content = `全科目の基礎問題だけで6割取る練習をします。得意の${strong[0]}だけは8割を狙いましょう。`;
            } else if (userDev < 60) {
                phase1Content = `${weakName}の苦手分野（例：ベクトルの計算、古文単語）を特定し、その単元だけを薄い問題集で集中特訓します。`;
                phase2Content = `共通テスト形式の問題集（緑本や黒本）で、時間を計って解きます。間違えた問題の「解説」を熟読し、なぜ間違えたかを言語化します。`;
                phase3Content = `本番と同じ時間割で予想問題を解きます。${strong[0]}で時間を稼ぎ、${weakName}に回す戦略を立てましょう。`;
            } else {
                phase1Title = "直近2週間：穴埋めと速度";
                phase1Content = `${weakName}でも偏差値60を切る単元がないかチェック。${strong[0]}は満点を狙うため、ケアレスミス防止のチェックリストを作成します。`;
                phase2Title = "来月：難問攻略";
                phase2Content = `Z会の予想問題など、少し難易度の高いセットで負荷をかけます。8割ではなく9割安定を目指すための「捨て問の見極め」を練習します。`;
                phase3Content = `体調管理を最優先しつつ、毎日全科目に触れて感覚を鈍らせないようにします。`;
            }

            html += `
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="font-bold text-slate-700 text-sm mb-1">${phase1Title}</div>
                    <p class="text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100">${phase1Content}</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="font-bold text-slate-700 text-sm mb-1">${phase2Title}</div>
                    <p class="text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100">${phase2Content}</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div class="font-bold text-slate-700 text-sm mb-1">${phase3Title}</div>
                    <p class="text-xs text-slate-600 bg-slate-50 p-2 rounded border border-slate-100">${phase3Content}</p>
                </div>
            </div>`;

            document.getElementById('strategyContent').innerHTML = html;
        }

        let chartInstance = null;
        function renderRadarChart(dataObj) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const labels = Object.keys(dataObj);
            const data = Object.values(dataObj);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '偏差値',
                        data: data,
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: '#6366f1',
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: '#e2e8f0' },
                            grid: { color: '#e2e8f0' },
                            pointLabels: { 
                                font: { size: 10, family: "'Noto Sans JP', sans-serif" },
                                color: '#64748b'
                            },
                            suggestedMin: 30,
                            suggestedMax: 70,
                            ticks: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false
                }
            });
        }

        // --- Simulator & Storage Functions ---

        function updateSimVal(key, val) {
            simulationOffsets[key] = parseInt(val);
            document.getElementById(`simVal_${key}`).innerText = `+${val}点`;
        }

        function saveData() {
            const field = document.getElementById('fieldSelect').value;
            const targetUni = document.getElementById('targetUni').value;
            localStorage.setItem('user_field', field);
            localStorage.setItem('user_target', targetUni);
            
            // Save inputs
            const inputs = document.getElementById('scoreInputs').querySelectorAll('input');
            inputs.forEach(input => {
                localStorage.setItem(input.id, input.value);
            });
        }

        function loadData() {
            const field = localStorage.getItem('user_field');
            if (field) document.getElementById('fieldSelect').value = field;
            
            const targetUni = localStorage.getItem('user_target');
            if (targetUni) document.getElementById('targetUni').value = targetUni;
            
            // Score inputs are loaded in updateFormUI logic
        }

        function resetData() {
            if(confirm('保存されたデータをすべて削除しますか？')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Initialize
        init();

    </script>
</body>
</html>
